/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2897: RuntimeWarning: invalid value encountered in divide
  c /= stddev[:, None]
/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2898: RuntimeWarning: invalid value encountered in divide
  c /= stddev[None, :]
================================================================================
COMPREHENSIVE EVALUATION REPORT
================================================================================

Generated: 2026-01-13T12:18:38.070546
Quick mode: True

================================================================================



################################################################################
# EVAL 01: PARAMETER RECOVERY
################################################################################


============================================================
EVAL 01: PARAMETER RECOVERY
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  X ~ Uniform(-2.0, 2.0)

Generating data (n=2000, seed=42)...
  Y: mean=0.6835, P(Y=1)=0.683
  T: mean=1.0011, std=0.7771
  X: range=[-1.99, 2.00]

Training StructuralNet (epochs=100)...

============================================================
RESULTS
============================================================

--- Recovery Metrics ---
Param      RMSE       Corr       Mean(hat)    Mean(true)  
------------------------------------------------------
α          0.5246     0.9832     0.2994       0.0001      
β          0.4947     0.5821     0.8634       0.9973      

--- Std Deviation ---
Param      Std(hat)     Std(true)   
----------------------------------
α          0.8067       0.3882      
β          0.3729       0.5843      

--- Training Quality ---
  Final val loss: 0.4798
  Best val loss: 0.4701
  Best epoch: 5
  Final train loss: 0.4824

============================================================
VALIDATION CRITERIA
============================================================
  RMSE(α) < 0.2: FAIL
  RMSE(β) < 0.1: FAIL
  Corr(α) > 0.8: PASS
  Corr(β) > 0.9: FAIL

============================================================
EVAL 01: FAIL
============================================================



################################################################################
# EVAL 02: AUTODIFF VS CALCULUS
################################################################################


============================================================
EVAL 02: AUTODIFF VS CALCULUS
============================================================

Logistic Loss:
  ℓ(y, t, θ) = -[y·log(p) + (1-y)·log(1-p)]
  where p = σ(α + β·t)

------------------------------------------------------------
SINGLE POINT TESTS
------------------------------------------------------------

  Test: y=1.0, t=0.5, θ=[0.1 2. ]
  p = σ(α + β·t) = 0.750260

  Score (∂ℓ/∂θ):
    Oracle:   [-0.249740, -0.124870]
    Autodiff: [-0.249740, -0.124870]
    Max Error: 2.78e-17

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.187370, 0.093685]
      [0.093685, 0.046842]
    Autodiff:
      [0.187370, 0.093685]
      [0.093685, 0.046842]
    Max Error: 2.78e-17

  Test: y=0.0, t=-1.0, θ=[0. 1.]
  p = σ(α + β·t) = 0.268941

  Score (∂ℓ/∂θ):
    Oracle:   [0.268941, -0.268941]
    Autodiff: [0.268941, -0.268941]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.196612, -0.196612]
      [-0.196612, 0.196612]
    Autodiff:
      [0.196612, -0.196612]
      [-0.196612, 0.196612]
    Max Error: 0.00e+00

  Test: y=1.0, t=0.0, θ=[1.  0.5]
  p = σ(α + β·t) = 0.731059

  Score (∂ℓ/∂θ):
    Oracle:   [-0.268941, -0.000000]
    Autodiff: [-0.268941, 0.000000]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.196612, 0.000000]
      [0.000000, 0.000000]
    Autodiff:
      [0.196612, 0.000000]
      [0.000000, 0.000000]
    Max Error: 0.00e+00

  Test: y=0.0, t=2.0, θ=[-0.5 -1. ]
  p = σ(α + β·t) = 0.075858

  Score (∂ℓ/∂θ):
    Oracle:   [0.075858, 0.151716]
    Autodiff: [0.075858, 0.151716]
    Max Error: 2.78e-17

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.070104, 0.140207]
      [0.140207, 0.280415]
    Autodiff:
      [0.070104, 0.140207]
      [0.140207, 0.280415]
    Max Error: 5.55e-17

  Test: y=1.0, t=0.01, θ=[0. 0.]
  p = σ(α + β·t) = 0.500000

  Score (∂ℓ/∂θ):
    Oracle:   [-0.500000, -0.005000]
    Autodiff: [-0.500000, -0.005000]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.250000, 0.002500]
      [0.002500, 0.000025]
    Autodiff:
      [0.250000, 0.002500]
      [0.002500, 0.000025]
    Max Error: 0.00e+00

------------------------------------------------------------
BATCHED VMAP TEST
------------------------------------------------------------

  Batched Test (n=100):
    Score max error: 2.22e-16
    Score mean error: 1.42e-17
    Hessian max error: 3.33e-16
    Hessian mean error: 2.18e-17

============================================================
SUMMARY
============================================================

Single-point tests (5 cases):
  Max score error: 2.78e-17
  Max Hessian error: 5.55e-17

Batched vmap test (n=100):
  Max score error: 2.22e-16
  Max Hessian error: 3.33e-16

============================================================
VALIDATION CRITERIA
============================================================
  Single Score: max|err| < 1e-6: PASS
  Single Hessian: max|err| < 1e-6: PASS
  Batched Score: max|err| < 1e-5: PASS
  Batched Hessian: max|err| < 1e-5: PASS

============================================================
EVAL 02: PASS
============================================================



################################################################################
# EVAL 03: LAMBDA ESTIMATION
################################################################################


============================================================
EVAL 03: LAMBDA ESTIMATION
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  T | X ~ N(β*(x), 0.5²)

Oracle: Λ(x) = E[ℓ_θθ | X=x]
  = E[p(1-p)·[[1,T],[T,T²]] | X=x]
  where p = σ(α*(x) + β*(x)·T)

Generating data (n=500, seed=42)...

Computing Oracle Λ(x) (MC samples=2000)...

Training EstimateLambda (aggregate method)...

============================================================
RESULTS
============================================================

--- Single Point Example (x=0) ---
  X[275] = 0.0061

  Oracle Λ:
    [0.1906, 0.1729]
    [0.1729, 0.2007]
  Eigenvalues: [0.02260444 0.36864991]

  Estimated Λ̂:
    [0.1559, 0.0961]
    [0.0961, 0.1220]
  Eigenvalues: [0.04139901 0.23649295]

--- Aggregate Metrics ---
  Mean Frobenius Error: 0.1212
  Max Frobenius Error: 0.1835
  Min eigenvalue (Λ̂): 0.041399
  Non-PSD count: 0/500
  Corr(λ₁, λ₁*): nan
  Mean λ₁ (hat): 0.2365
  Mean λ₁ (oracle): 0.2516

--- Note ---
  EstimateLambda(aggregate) returns mean(Hessians), losing x-dependence.
  This is stable but may miss heterogeneity in Λ(x).

============================================================
VALIDATION CRITERIA
============================================================
  All eigenvalues > 0 (PSD): PASS
  Mean Frobenius Error < 1.0: PASS
  Min eigenvalue > 0: PASS

============================================================
EVAL 03: PASS
============================================================



################################################################################
# EVAL 04: TARGET JACOBIAN
################################################################################


============================================================
EVAL 04: TARGET JACOBIAN
============================================================

Target: AME at t̃
  H(θ) = σ(α + β·t̃)·(1 - σ(α + β·t̃))·β

Jacobian:
  ∂H/∂α = β·σ(1-σ)(1-2σ)
  ∂H/∂β = σ(1-σ) + β·t̃·σ(1-σ)(1-2σ)

------------------------------------------------------------
SINGLE POINT TESTS (t̃=0)
------------------------------------------------------------

  Test: θ=[0. 1.], t̃=0.0
  σ(α + β·t̃) = 0.500000
  H(θ) = σ(1-σ)β = 0.250000

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.000000, 0.250000]
    Autodiff: [0.000000, 0.250000]
    Max Error: 0.00e+00

  Test: θ=[1.  0.5], t̃=0.0
  σ(α + β·t̃) = 0.731059
  H(θ) = σ(1-σ)β = 0.098306

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.045429, 0.196612]
    Autodiff: [-0.045429, 0.196612]
    Max Error: 6.94e-18

  Test: θ=[-0.5  2. ], t̃=0.0
  σ(α + β·t̃) = 0.377541
  H(θ) = σ(1-σ)β = 0.470007

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.115114, 0.235004]
    Autodiff: [0.115114, 0.235004]
    Max Error: 1.39e-17

  Test: θ=[ 0.1 -1. ], t̃=0.0
  σ(α + β·t̃) = 0.524979
  H(θ) = σ(1-σ)β = -0.249376

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.012458, 0.249376]
    Autodiff: [0.012458, 0.249376]
    Max Error: 0.00e+00

  Test: θ=[2.  0.1], t̃=0.0
  σ(α + β·t̃) = 0.880797
  H(θ) = σ(1-σ)β = 0.010499

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.007996, 0.104994]
    Autodiff: [-0.007996, 0.104994]
    Max Error: 1.73e-18

------------------------------------------------------------
SINGLE POINT TESTS (t̃=0.5)
------------------------------------------------------------

  Test: θ=[0. 1.], t̃=0.5
  σ(α + β·t̃) = 0.622459
  H(θ) = σ(1-σ)β = 0.235004

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.057557, 0.206225]
    Autodiff: [-0.057557, 0.206225]
    Max Error: 6.94e-18

  Test: θ=[1.  0.5], t̃=0.5
  σ(α + β·t̃) = 0.777300
  H(θ) = σ(1-σ)β = 0.086552

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.048002, 0.149104]
    Autodiff: [-0.048002, 0.149104]
    Max Error: 0.00e+00

  Test: θ=[-0.5  2. ], t̃=0.5
  σ(α + β·t̃) = 0.622459
  H(θ) = σ(1-σ)β = 0.470007

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.115114, 0.177447]
    Autodiff: [-0.115114, 0.177447]
    Max Error: 2.78e-17

------------------------------------------------------------
BATCHED VMAP TESTS
------------------------------------------------------------

  Batched Test (n=100, t̃=0.0):
    Max error: 4.16e-17
    Mean error: 3.99e-18

  Batched Test (n=100, t̃=0.5):
    Max error: 5.55e-17
    Mean error: 6.47e-18

============================================================
SUMMARY
============================================================

Single-point tests (t̃=0): max error = 1.39e-17
Single-point tests (t̃=0.5): max error = 2.78e-17
Batched test (t̃=0): max error = 4.16e-17
Batched test (t̃=0.5): max error = 5.55e-17

============================================================
VALIDATION CRITERIA
============================================================
  Single t̃=0: max|err| < 1e-5: PASS
  Single t̃=0.5: max|err| < 1e-5: PASS
  Batched t̃=0: max|err| < 1e-5: PASS
  Batched t̃=0.5: max|err| < 1e-5: PASS

============================================================
EVAL 04: PASS
============================================================



################################################################################
# EVAL 05: INFLUENCE FUNCTION ASSEMBLY
################################################################################


============================================================
EVAL 05: INFLUENCE FUNCTION ASSEMBLY
============================================================

Formula (Theorem 2):
  ψ_i = H(θ_i) - H_θ(θ_i) · Λ(x_i)⁻¹ · ℓ_θ(y_i, t_i, θ_i)

Generating data (n=500, seed=42)...
  True μ* = 0.241016

Computing Oracle ψ...
  Mean(ψ_oracle) = 0.217513
  Std(ψ_oracle) = 1.047620

Computing Package ψ...
  Mean(ψ_package) = 0.219130
  Std(ψ_package) = 0.987821

============================================================
RESULTS
============================================================

--- ψ Assembly Comparison ---
  Metric               Package         Oracle         
--------------------------------------------------
  Mean                 0.219130        0.217513       
  Std                  0.987821        1.047620       

--- Assembly Quality ---
  Correlation(ψ̂, ψ*): 0.9999
  Bias (ψ̂ - ψ*): 0.001617
  RMSE: 0.060896

--- Inference Check ---
  True μ*: 0.241016
  Mean(ψ_oracle): 0.217513
  Mean(ψ_package): 0.219130
  Oracle bias from true: -0.023503
  Package bias from true: -0.021886

--- Sample ψ Values (first 10) ---
  i     ψ_oracle        ψ_package       diff           
--------------------------------------------------
  0     0.702877        0.678873        -0.024004      
  1     0.477823        0.475992        -0.001831      
  2     0.573883        0.559876        -0.014007      
  3     0.543419        0.525891        -0.017528      
  4     -1.657038       -1.553531       0.103507       
  5     0.009192        0.018773        0.009581       
  6     -2.823530       -2.661362       0.162168       
  7     0.466128        0.462474        -0.003654      
  8     0.740281        0.713959        -0.026322      
  9     0.604722        0.585741        -0.018981      

============================================================
VALIDATION CRITERIA
============================================================
  Corr(ψ̂, ψ*) > 0.9: PASS
  |Bias| < 0.1: PASS
  RMSE < 0.5: PASS

============================================================
EVAL 05: PASS
============================================================



################################################################################
# EVAL 06: FREQUENTIST COVERAGE
################################################################################


============================================================
EVAL 06: FREQUENTIST COVERAGE
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  True μ* = 0.241016

Simulation Settings:
  M = 10 replications
  n = 500 observations
  n_folds = 10
  epochs = 30

------------------------------------------------------------
RUNNING SIMULATIONS
------------------------------------------------------------
  Running simulation 5/10...
  Running simulation 10/10...

============================================================
RESULTS
============================================================

--- Simulation Summary ---
  Total simulations: 10
  Valid simulations: 10
  Failed simulations: 0

--- Point Estimation ---
  True μ*: 0.241016
  Mean(μ̂): 0.125036
  Std(μ̂): 0.027706
  Bias: -0.115980

--- Standard Error ---
  Empirical SE: 0.027706
  Mean SE (IF): 0.039970
  SE Ratio: 0.6932

--- Coverage ---
  Coverage: 20.0% (2/10)

--- z-Score Distribution ---
  Mean z: -2.9162 (should be ~0)
  Std z: 0.6839 (should be ~1)

--- Individual Results (first 10) ---
  Sim   μ̂         SE         CI_lo      CI_hi      Cov   z         
-----------------------------------------------------------------
  1     0.1281     0.0360     0.0575     0.1987     F     -3.1331   
  2     0.1706     0.0406     0.0911     0.2501     T     -1.7369   
  3     0.1162     0.0350     0.0477     0.1847     F     -3.5707   
  4     0.0872     0.0510     -0.0128    0.1872     F     -3.0141   
  5     0.1110     0.0363     0.0399     0.1821     F     -3.5844   
  6     0.1268     0.0377     0.0528     0.2008     F     -3.0263   
  7     0.1358     0.0413     0.0549     0.2167     F     -2.5492   
  8     0.1723     0.0391     0.0957     0.2489     T     -1.7586   
  9     0.1154     0.0427     0.0317     0.1991     F     -2.9412   
  10    0.0871     0.0400     0.0086     0.1655     F     -3.8477   

============================================================
VALIDATION CRITERIA
============================================================
  Coverage in [85%, 99%]: FAIL
  SE Ratio in [0.5, 2.0]: PASS
  |Bias| < 0.1: FAIL
  |z_mean| < 0.5: FAIL
  z_std in [0.5, 2.0]: PASS

============================================================
EVAL 06: FAIL (may need more M or tuning)
============================================================



################################################################################
# FINAL SUMMARY
################################################################################


============================================================
EVALUATION SCORECARD
============================================================

Eval                           Status    
----------------------------------------
EVAL 01                        FAIL      
EVAL 02                        PASS      
EVAL 03                        PASS      
EVAL 04                        PASS      
EVAL 05                        PASS      
EVAL 06                        FAIL      
----------------------------------------
OVERALL                        SOME FAILED
============================================================

--- Detailed Metrics ---

Eval 01 (Parameter Recovery):
  RMSE(α): 0.5246
  RMSE(β): 0.4947
  Corr(α): 0.9832
  Corr(β): 0.5821

Eval 02 (Autodiff):
  Max Score Error: 2.22e-16
  Max Hessian Error: 3.33e-16

Eval 03 (Lambda):
  Mean Frobenius Error: 0.1212
  Min Eigenvalue: 0.041399

Eval 04 (Target Jacobian):
  Max Error (t̃=0): 4.16e-17

Eval 05 (Psi Assembly):
  Correlation: 0.9999
  Bias: 0.001617
  RMSE: 0.060896

Eval 06 (Coverage):
  Coverage: 20.0%
  SE Ratio: 0.6932
  Bias: -0.115980
  z_mean: -2.9162
  z_std: 0.6839

================================================================================
END OF REPORT
================================================================================
