/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2897: RuntimeWarning: invalid value encountered in divide
  c /= stddev[:, None]
/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2898: RuntimeWarning: invalid value encountered in divide
  c /= stddev[None, :]
================================================================================
COMPREHENSIVE EVALUATION REPORT
================================================================================

Generated: 2026-01-13T12:19:36.334740
Quick mode: False

================================================================================



################################################################################
# EVAL 01: PARAMETER RECOVERY
################################################################################


============================================================
EVAL 01: PARAMETER RECOVERY
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  X ~ Uniform(-2.0, 2.0)

Generating data (n=5000, seed=42)...
  Y: mean=0.6898, P(Y=1)=0.690
  T: mean=0.9844, std=0.7614
  X: range=[-2.00, 2.00]

Training StructuralNet (epochs=200)...

============================================================
RESULTS
============================================================

--- Recovery Metrics ---
Param      RMSE       Corr       Mean(hat)    Mean(true)  
------------------------------------------------------
α          0.3455     0.9743     0.2764       -0.0031     
β          0.2978     0.9567     0.8077       0.9937      

--- Std Deviation ---
Param      Std(hat)     Std(true)   
----------------------------------
α          0.5600       0.3865      
β          0.7143       0.5792      

--- Training Quality ---
  Final val loss: 0.4856
  Best val loss: 0.4826
  Best epoch: 15
  Final train loss: 0.4812

============================================================
VALIDATION CRITERIA
============================================================
  RMSE(α) < 0.2: FAIL
  RMSE(β) < 0.1: FAIL
  Corr(α) > 0.8: PASS
  Corr(β) > 0.9: PASS

============================================================
EVAL 01: FAIL
============================================================



################################################################################
# EVAL 02: AUTODIFF VS CALCULUS
################################################################################


============================================================
EVAL 02: AUTODIFF VS CALCULUS
============================================================

Logistic Loss:
  ℓ(y, t, θ) = -[y·log(p) + (1-y)·log(1-p)]
  where p = σ(α + β·t)

------------------------------------------------------------
SINGLE POINT TESTS
------------------------------------------------------------

  Test: y=1.0, t=0.5, θ=[0.1 2. ]
  p = σ(α + β·t) = 0.750260

  Score (∂ℓ/∂θ):
    Oracle:   [-0.249740, -0.124870]
    Autodiff: [-0.249740, -0.124870]
    Max Error: 2.78e-17

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.187370, 0.093685]
      [0.093685, 0.046842]
    Autodiff:
      [0.187370, 0.093685]
      [0.093685, 0.046842]
    Max Error: 2.78e-17

  Test: y=0.0, t=-1.0, θ=[0. 1.]
  p = σ(α + β·t) = 0.268941

  Score (∂ℓ/∂θ):
    Oracle:   [0.268941, -0.268941]
    Autodiff: [0.268941, -0.268941]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.196612, -0.196612]
      [-0.196612, 0.196612]
    Autodiff:
      [0.196612, -0.196612]
      [-0.196612, 0.196612]
    Max Error: 0.00e+00

  Test: y=1.0, t=0.0, θ=[1.  0.5]
  p = σ(α + β·t) = 0.731059

  Score (∂ℓ/∂θ):
    Oracle:   [-0.268941, -0.000000]
    Autodiff: [-0.268941, 0.000000]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.196612, 0.000000]
      [0.000000, 0.000000]
    Autodiff:
      [0.196612, 0.000000]
      [0.000000, 0.000000]
    Max Error: 0.00e+00

  Test: y=0.0, t=2.0, θ=[-0.5 -1. ]
  p = σ(α + β·t) = 0.075858

  Score (∂ℓ/∂θ):
    Oracle:   [0.075858, 0.151716]
    Autodiff: [0.075858, 0.151716]
    Max Error: 2.78e-17

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.070104, 0.140207]
      [0.140207, 0.280415]
    Autodiff:
      [0.070104, 0.140207]
      [0.140207, 0.280415]
    Max Error: 5.55e-17

  Test: y=1.0, t=0.01, θ=[0. 0.]
  p = σ(α + β·t) = 0.500000

  Score (∂ℓ/∂θ):
    Oracle:   [-0.500000, -0.005000]
    Autodiff: [-0.500000, -0.005000]
    Max Error: 0.00e+00

  Hessian (∂²ℓ/∂θ²):
    Oracle:
      [0.250000, 0.002500]
      [0.002500, 0.000025]
    Autodiff:
      [0.250000, 0.002500]
      [0.002500, 0.000025]
    Max Error: 0.00e+00

------------------------------------------------------------
BATCHED VMAP TEST
------------------------------------------------------------

  Batched Test (n=100):
    Score max error: 2.22e-16
    Score mean error: 1.42e-17
    Hessian max error: 3.33e-16
    Hessian mean error: 2.18e-17

============================================================
SUMMARY
============================================================

Single-point tests (5 cases):
  Max score error: 2.78e-17
  Max Hessian error: 5.55e-17

Batched vmap test (n=100):
  Max score error: 2.22e-16
  Max Hessian error: 3.33e-16

============================================================
VALIDATION CRITERIA
============================================================
  Single Score: max|err| < 1e-6: PASS
  Single Hessian: max|err| < 1e-6: PASS
  Batched Score: max|err| < 1e-5: PASS
  Batched Hessian: max|err| < 1e-5: PASS

============================================================
EVAL 02: PASS
============================================================



################################################################################
# EVAL 03: LAMBDA ESTIMATION
################################################################################


============================================================
EVAL 03: LAMBDA ESTIMATION
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  T | X ~ N(β*(x), 0.5²)

Oracle: Λ(x) = E[ℓ_θθ | X=x]
  = E[p(1-p)·[[1,T],[T,T²]] | X=x]
  where p = σ(α*(x) + β*(x)·T)

Generating data (n=1000, seed=42)...

Computing Oracle Λ(x) (MC samples=5000)...

Training EstimateLambda (aggregate method)...

============================================================
RESULTS
============================================================

--- Single Point Example (x=0) ---
  X[275] = 0.0061

  Oracle Λ:
    [0.1907, 0.1730]
    [0.1730, 0.2003]
  Eigenvalues: [0.02247211 0.36856474]

  Estimated Λ̂:
    [0.1587, 0.1077]
    [0.1077, 0.1289]
  Eigenvalues: [0.03505629 0.25256392]

--- Aggregate Metrics ---
  Mean Frobenius Error: 0.1191
  Max Frobenius Error: 0.2000
  Min eigenvalue (Λ̂): 0.035056
  Non-PSD count: 0/1000
  Corr(λ₁, λ₁*): nan
  Mean λ₁ (hat): 0.2526
  Mean λ₁ (oracle): 0.2569

--- Note ---
  EstimateLambda(aggregate) returns mean(Hessians), losing x-dependence.
  This is stable but may miss heterogeneity in Λ(x).

============================================================
VALIDATION CRITERIA
============================================================
  All eigenvalues > 0 (PSD): PASS
  Mean Frobenius Error < 1.0: PASS
  Min eigenvalue > 0: PASS

============================================================
EVAL 03: PASS
============================================================



################################################################################
# EVAL 04: TARGET JACOBIAN
################################################################################


============================================================
EVAL 04: TARGET JACOBIAN
============================================================

Target: AME at t̃
  H(θ) = σ(α + β·t̃)·(1 - σ(α + β·t̃))·β

Jacobian:
  ∂H/∂α = β·σ(1-σ)(1-2σ)
  ∂H/∂β = σ(1-σ) + β·t̃·σ(1-σ)(1-2σ)

------------------------------------------------------------
SINGLE POINT TESTS (t̃=0)
------------------------------------------------------------

  Test: θ=[0. 1.], t̃=0.0
  σ(α + β·t̃) = 0.500000
  H(θ) = σ(1-σ)β = 0.250000

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.000000, 0.250000]
    Autodiff: [0.000000, 0.250000]
    Max Error: 0.00e+00

  Test: θ=[1.  0.5], t̃=0.0
  σ(α + β·t̃) = 0.731059
  H(θ) = σ(1-σ)β = 0.098306

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.045429, 0.196612]
    Autodiff: [-0.045429, 0.196612]
    Max Error: 6.94e-18

  Test: θ=[-0.5  2. ], t̃=0.0
  σ(α + β·t̃) = 0.377541
  H(θ) = σ(1-σ)β = 0.470007

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.115114, 0.235004]
    Autodiff: [0.115114, 0.235004]
    Max Error: 1.39e-17

  Test: θ=[ 0.1 -1. ], t̃=0.0
  σ(α + β·t̃) = 0.524979
  H(θ) = σ(1-σ)β = -0.249376

  Target Jacobian ∂H/∂θ:
    Oracle:   [0.012458, 0.249376]
    Autodiff: [0.012458, 0.249376]
    Max Error: 0.00e+00

  Test: θ=[2.  0.1], t̃=0.0
  σ(α + β·t̃) = 0.880797
  H(θ) = σ(1-σ)β = 0.010499

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.007996, 0.104994]
    Autodiff: [-0.007996, 0.104994]
    Max Error: 1.73e-18

------------------------------------------------------------
SINGLE POINT TESTS (t̃=0.5)
------------------------------------------------------------

  Test: θ=[0. 1.], t̃=0.5
  σ(α + β·t̃) = 0.622459
  H(θ) = σ(1-σ)β = 0.235004

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.057557, 0.206225]
    Autodiff: [-0.057557, 0.206225]
    Max Error: 6.94e-18

  Test: θ=[1.  0.5], t̃=0.5
  σ(α + β·t̃) = 0.777300
  H(θ) = σ(1-σ)β = 0.086552

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.048002, 0.149104]
    Autodiff: [-0.048002, 0.149104]
    Max Error: 0.00e+00

  Test: θ=[-0.5  2. ], t̃=0.5
  σ(α + β·t̃) = 0.622459
  H(θ) = σ(1-σ)β = 0.470007

  Target Jacobian ∂H/∂θ:
    Oracle:   [-0.115114, 0.177447]
    Autodiff: [-0.115114, 0.177447]
    Max Error: 2.78e-17

------------------------------------------------------------
BATCHED VMAP TESTS
------------------------------------------------------------

  Batched Test (n=100, t̃=0.0):
    Max error: 4.16e-17
    Mean error: 3.99e-18

  Batched Test (n=100, t̃=0.5):
    Max error: 5.55e-17
    Mean error: 6.47e-18

============================================================
SUMMARY
============================================================

Single-point tests (t̃=0): max error = 1.39e-17
Single-point tests (t̃=0.5): max error = 2.78e-17
Batched test (t̃=0): max error = 4.16e-17
Batched test (t̃=0.5): max error = 5.55e-17

============================================================
VALIDATION CRITERIA
============================================================
  Single t̃=0: max|err| < 1e-5: PASS
  Single t̃=0.5: max|err| < 1e-5: PASS
  Batched t̃=0: max|err| < 1e-5: PASS
  Batched t̃=0.5: max|err| < 1e-5: PASS

============================================================
EVAL 04: PASS
============================================================



################################################################################
# EVAL 05: INFLUENCE FUNCTION ASSEMBLY
################################################################################


============================================================
EVAL 05: INFLUENCE FUNCTION ASSEMBLY
============================================================

Formula (Theorem 2):
  ψ_i = H(θ_i) - H_θ(θ_i) · Λ(x_i)⁻¹ · ℓ_θ(y_i, t_i, θ_i)

Generating data (n=1000, seed=42)...
  True μ* = 0.241016

Computing Oracle ψ...
  Mean(ψ_oracle) = 0.239665
  Std(ψ_oracle) = 0.997282

Computing Package ψ...
  Mean(ψ_package) = 0.240729
  Std(ψ_package) = 1.050036

============================================================
RESULTS
============================================================

--- ψ Assembly Comparison ---
  Metric               Package         Oracle         
--------------------------------------------------
  Mean                 0.240729        0.239665       
  Std                  1.050036        0.997282       

--- Assembly Quality ---
  Correlation(ψ̂, ψ*): 0.9952
  Bias (ψ̂ - ψ*): 0.001064
  RMSE: 0.113600

--- Inference Check ---
  True μ*: 0.241016
  Mean(ψ_oracle): 0.239665
  Mean(ψ_package): 0.240729
  Oracle bias from true: -0.001351
  Package bias from true: -0.000287

--- Sample ψ Values (first 10) ---
  i     ψ_oracle        ψ_package       diff           
--------------------------------------------------
  0     -0.413453       -0.291050       0.122403       
  1     0.585815        0.581280        -0.004534      
  2     0.605171        0.609209        0.004037       
  3     0.750484        0.748464        -0.002020      
  4     0.083180        -0.063097       -0.146277      
  5     -0.371062       -0.284522       0.086541       
  6     0.139185        0.249243        0.110059       
  7     0.528806        0.533492        0.004686       
  8     0.680826        0.659799        -0.021027      
  9     0.219357        0.140883        -0.078474      

============================================================
VALIDATION CRITERIA
============================================================
  Corr(ψ̂, ψ*) > 0.9: PASS
  |Bias| < 0.1: PASS
  RMSE < 0.5: PASS

============================================================
EVAL 05: PASS
============================================================



################################################################################
# EVAL 06: FREQUENTIST COVERAGE
################################################################################


============================================================
EVAL 06: FREQUENTIST COVERAGE
============================================================

DGP:
  α*(x) = 0.0 + 0.5·sin(x)
  β*(x) = 1.0 + 0.5·x
  True μ* = 0.241016

Simulation Settings:
  M = 20 replications
  n = 1000 observations
  n_folds = 20
  epochs = 50

------------------------------------------------------------
RUNNING SIMULATIONS
------------------------------------------------------------
  Running simulation 5/20...
  Running simulation 10/20...
  Running simulation 15/20...
  Running simulation 20/20...

============================================================
RESULTS
============================================================

--- Simulation Summary ---
  Total simulations: 20
  Valid simulations: 20
  Failed simulations: 0

--- Point Estimation ---
  True μ*: 0.241016
  Mean(μ̂): 0.139319
  Std(μ̂): 0.023229
  Bias: -0.101697

--- Standard Error ---
  Empirical SE: 0.023229
  Mean SE (IF): 0.028041
  SE Ratio: 0.8284

--- Coverage ---
  Coverage: 0.0% (0/20)

--- z-Score Distribution ---
  Mean z: -3.6168 (should be ~0)
  Std z: 0.7745 (should be ~1)

--- Individual Results (first 10) ---
  Sim   μ̂         SE         CI_lo      CI_hi      Cov   z         
-----------------------------------------------------------------
  1     0.1566     0.0285     0.1008     0.2124     F     -2.9650   
  2     0.1510     0.0279     0.0964     0.2056     F     -3.2294   
  3     0.0912     0.0279     0.0365     0.1459     F     -5.3683   
  4     0.1190     0.0266     0.0668     0.1712     F     -4.5836   
  5     0.1376     0.0285     0.0817     0.1934     F     -3.6292   
  6     0.1398     0.0272     0.0865     0.1931     F     -3.7220   
  7     0.1357     0.0267     0.0833     0.1880     F     -3.9457   
  8     0.1896     0.0254     0.1398     0.2394     F     -2.0217   
  9     0.1623     0.0278     0.1079     0.2168     F     -2.8334   
  10    0.1377     0.0280     0.0829     0.1926     F     -3.6903   

============================================================
VALIDATION CRITERIA
============================================================
  Coverage in [85%, 99%]: FAIL
  SE Ratio in [0.5, 2.0]: PASS
  |Bias| < 0.1: FAIL
  |z_mean| < 0.5: FAIL
  z_std in [0.5, 2.0]: PASS

============================================================
EVAL 06: FAIL (may need more M or tuning)
============================================================



################################################################################
# FINAL SUMMARY
################################################################################


============================================================
EVALUATION SCORECARD
============================================================

Eval                           Status    
----------------------------------------
EVAL 01                        FAIL      
EVAL 02                        PASS      
EVAL 03                        PASS      
EVAL 04                        PASS      
EVAL 05                        PASS      
EVAL 06                        FAIL      
----------------------------------------
OVERALL                        SOME FAILED
============================================================

--- Detailed Metrics ---

Eval 01 (Parameter Recovery):
  RMSE(α): 0.3455
  RMSE(β): 0.2978
  Corr(α): 0.9743
  Corr(β): 0.9567

Eval 02 (Autodiff):
  Max Score Error: 2.22e-16
  Max Hessian Error: 3.33e-16

Eval 03 (Lambda):
  Mean Frobenius Error: 0.1191
  Min Eigenvalue: 0.035056

Eval 04 (Target Jacobian):
  Max Error (t̃=0): 4.16e-17

Eval 05 (Psi Assembly):
  Correlation: 0.9952
  Bias: 0.001064
  RMSE: 0.113600

Eval 06 (Coverage):
  Coverage: 0.0%
  SE Ratio: 0.8284
  Bias: -0.101697
  z_mean: -3.6168
  z_std: 0.7745

================================================================================
END OF REPORT
================================================================================
