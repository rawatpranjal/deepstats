/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2897: RuntimeWarning: invalid value encountered in divide
  c /= stddev[:, None]
/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2898: RuntimeWarning: invalid value encountered in divide
  c /= stddev[None, :]
============================================================
EVAL 03: LAMBDA ESTIMATION (RUTHLESS)
============================================================

This eval tests Lambda estimation across ALL THREE REGIMES.
We WANT to see FAIL when implementation is wrong.

============================================================
PART A: Regime A (RCT) - ComputeLambda
============================================================

  Test A1: Quadrature vs MC (50k samples)
    Lambda_quad =
      [[0.198986, -0.029888],
       [-0.029888, 0.144326]]
    Eigenvalues: [0.131156, 0.212156]
    Condition number: 1.62
    Determinant: 0.027826
    Lambda_mc =
      [[0.198964, -0.029879],
       [-0.029879, 0.144401]]
    Relative error: 0.03%
    Test A1: PASS (threshold < 1%)

  Test A2: MC convergence rate
    M=  100: error=0.034347
    M=  500: error=0.009617
    M= 1000: error=0.007973
    M= 5000: error=0.006212
    Fitted rate: 0.43 (should be ~0.5)
    Test A2: PASS (0.3 < rate < 0.7)

  Test A3: Y-independence
    ||Lambda1 - Lambda2|| = 0.00e+00
    Test A3: PASS (should be 0)

  Test A4: ComputeLambda package
    Lambda_pkg =
      [[0.198843, -0.029665],
       [-0.029665, 0.144722]]
    Relative error vs quadrature: 0.21%
    Test A4: PASS (threshold < 5%)

  Part A completed in 1.17s

============================================================
PART B: Regime B (Linear) - AnalyticLambda
============================================================

  Test B1: Lambda = E[TT'|X] analytical
    x=0.00: E[T|X]=0.0000, E[T^2|X]=1.0000, cond=1.00, error=0.00e+00
    x=0.25: E[T|X]=0.1250, E[T^2|X]=1.0156, cond=1.28, error=0.00e+00
    x=0.50: E[T|X]=0.2500, E[T^2|X]=1.0625, cond=1.65, error=0.00e+00
    x=0.75: E[T|X]=0.3750, E[T^2|X]=1.1406, cond=2.11, error=0.00e+00
    x=1.00: E[T|X]=0.5000, E[T^2|X]=1.2500, cond=2.69, error=0.00e+00
    Condition number range: [1.00, 2.69]
    Test B1: PASS (max error < 1%)

  Test B2: theta-independence
    Testing at x=0.5 with different theta values
    Max ||Lambda(theta) - Lambda(theta')|| = 0.00e+00
    Test B2: PASS (should be 0)

  Test B3: Confounded T at x=0.25
    n_samples near x: 996
    Lambda_empirical =
      [[1.0000, 0.1551],
       [0.1551, 0.9677]]
    Lambda_oracle =
      [[1.0000, 0.1250],
       [0.1250, 1.0156]]
    Relative error: 4.5%

  Test B3: Confounded T at x=0.50
    n_samples near x: 966
    Lambda_empirical =
      [[1.0000, 0.2042],
       [0.2042, 1.0863]]
    Lambda_oracle =
      [[1.0000, 0.2500],
       [0.2500, 1.0625]]
    Relative error: 4.6%

  Test B3: Confounded T at x=0.75
    n_samples near x: 1009
    Lambda_empirical =
      [[1.0000, 0.3327],
       [0.3327, 1.1633]]
    Lambda_oracle =
      [[1.0000, 0.3750],
       [0.3750, 1.1406]]
    Relative error: 4.0%
    Test B3: PASS (max error < 10%)

  Test B4: AnalyticLambda package (aggregate)
    Lambda_pkg (mean TT') =
      [[1.0000, 0.2300],
       [0.2300, 1.1057]]
    Lambda_oracle at x=0.5 =
      [[1.0000, 0.2500],
       [0.2500, 1.0625]]
    Relative error: 3.4%
    Test B4: PASS (threshold < 20%)

  Part B completed in 0.01s

============================================================
PART C: Regime C (Obs) - EstimateLambda (ALL METHODS)
============================================================

  DGP: Regime C (Confounded Logit)
    alpha*(x) = 0.0 + 0.5*sin(x)
    beta*(x) = 1.0 + 0.5*x
    T | X ~ N(beta*(x), 0.5^2)

  Computing Oracle Lambda(x) for 500 points (MC=5000)...
  Oracle computation time: 6.44s
  Oracle stats:
    eig_max: mean=0.2519, std=0.0985
    eig_min: mean=0.0262, std=0.0207
    element-wise std: 0.0609

  Testing 5 methods: ['aggregate', 'mlp', 'ridge', 'rf', 'lgbm']
------------------------------------------------------------

  --- Method: aggregate ---
    Corr(eig1): 0.0000 FAIL
    Mean Frob:  0.1211 PASS
    Max Frob:   0.1837
    P95 Frob:   0.1735
    Std (x-dep): 0.000000 FAIL
    Min eig:    0.041399 (PSD: 100%)
    Bias:       -0.001129
    Var ratio:  0.0000
    Time:       0.038s (fit=0.017s, pred=0.021s)

  --- Method: mlp ---
    Corr(eig1): 0.9972 PASS
    Mean Frob:  0.0173 PASS
    Max Frob:   0.0507
    P95 Frob:   0.0377
    Std (x-dep): 0.064829 PASS
    Min eig:    0.000883 (PSD: 100%)
    Bias:       0.000715
    Var ratio:  1.1184
    Time:       12.239s (fit=12.211s, pred=0.028s)

  --- Method: ridge ---
    Corr(eig1): 0.5079 FAIL
    Mean Frob:  0.0868 PASS
    Max Frob:   0.1548
    P95 Frob:   0.1438
    Std (x-dep): 0.021836 PASS
    Min eig:    0.001825 (PSD: 100%)
    Bias:       -0.001030
    Var ratio:  0.3755
    Time:       0.040s (fit=0.026s, pred=0.014s)

  --- Method: rf ---
    Corr(eig1): 0.9043 PASS
    Mean Frob:  0.0602 PASS
    Max Frob:   0.4046
    P95 Frob:   0.1782
    Std (x-dep): 0.078443 PASS
    Min eig:    0.000443 (PSD: 100%)
    Bias:       -0.000877
    Var ratio:  1.5826
    Time:       0.157s (fit=0.127s, pred=0.030s)

  --- Method: lgbm ---
    Corr(eig1): 0.9777 PASS
    Mean Frob:  0.0326 PASS
    Max Frob:   0.1489
    P95 Frob:   0.0951
    Std (x-dep): 0.068611 PASS
    Min eig:    0.000732 (PSD: 100%)
    Bias:       -0.001124
    Var ratio:  1.2347
    Time:       0.497s (fit=0.485s, pred=0.013s)

--------------------------------------------------------------------------------
  METHOD COMPARISON TABLE (Extended)
--------------------------------------------------------------------------------
  Method     Corr     Frob     Max      P95      MinEig   PSD%   Time    
  ------------------------------------------------------------------------------
  aggregate  0.0000   0.1211   0.1837   0.1735   0.0414   100    0.038   
  mlp        0.9972   0.0173   0.0507   0.0377   0.0009   100    12.239  
  ridge      0.5079   0.0868   0.1548   0.1438   0.0018   100    0.040   
  rf         0.9043   0.0602   0.4046   0.1782   0.0004   100    0.157   
  lgbm       0.9777   0.0326   0.1489   0.0951   0.0007   100    0.497   

--------------------------------------------------------------------------------
  ADDITIONAL STATISTICS
--------------------------------------------------------------------------------
  Method     Bias       MAE        VarRatio   R²         Result    
  ------------------------------------------------------------------------------
  aggregate  -0.001129  0.055160   0.0000     -0.0009    1/3       
  mlp        0.000715   0.007533   1.1184     0.9676     3/3 PASS  
  ridge      -0.001030  0.041597   0.3755     0.2382     2/3       
  rf         -0.000877  0.025601   1.5826     0.3759     3/3 PASS  
  lgbm       -0.001124  0.013240   1.2347     0.8316     3/3 PASS  

  BEST METHOD: mlp (3/3 tests passed)

  Part C completed in 19.44s
    - Oracle computation: 6.44s
    - aggregate: 0.04s
    - mlp: 12.24s
    - ridge: 0.04s
    - rf: 0.16s
    - lgbm: 0.50s

============================================================
TIMING SUMMARY
============================================================
  Part A (RCT):           1.17s
  Part B (Linear):        0.01s
  Part C (Observational): 19.44s
  ------------------------------
  TOTAL:                  20.63s

============================================================
SUMMARY
============================================================

  Part A (RCT):
    A1: Quadrature vs MC............PASS (0.03%)
    A2: MC convergence rate.........PASS (rate=0.43)
    A3: Y-independence..............PASS (diff=0.00e+00)
    A4: ComputeLambda package.......PASS (0.21%)

  Part B (Linear):
    B1: Lambda = E[TT'|X]...........PASS (error=0.00e+00)
    B2: theta-independence..........PASS (diff=0.00e+00)
    B3: Confounded T................PASS (error=4.6%)
    B4: AnalyticLambda package......PASS (3.4%)

  Part C (Observational):
    C1: Corr(lambda_1_hat, lambda_1*)..PASS (1.00)
    C2: Mean Frobenius..............PASS (0.0173)
    C3: x-dependence................PASS (std=0.0648)

============================================================
STATISTICS SUMMARY (Best Method: mlp)
============================================================
  Correlation:     0.9972 (threshold: 0.70)
  Mean Frobenius:  0.0173 (threshold: 0.15)
  Max Frobenius:   0.0507
  95th percentile: 0.0377
  Min Eigenvalue:  0.000883 (>0 = PSD)
  PSD Rate:        100%
  Bias:            0.000715 (should be ~0)
  Variance Ratio:  1.1184 (should be ~1)
  Mean R²:         0.9676

============================================================
EVAL 03: 11/11 PASSED
STATUS: ALL PASS
============================================================

============================================================
PART G: REGULARIZATION STRATEGY COMPARISON
============================================================

Comparing: Absolute floor vs Relative floor vs Tikhonov

  Testing 6 regularization strategies...
--------------------------------------------------------------------------------
  absolute_1e-4        ratio=0.729 corr=nan mean_err=34.1% p95=79.6% cond=5.7
  absolute_1e-6        ratio=0.729 corr=nan mean_err=34.1% p95=79.6% cond=5.7
  relative_cond100     ratio=0.730 corr=nan mean_err=34.1% p95=79.6% cond=5.7
  relative_cond50      ratio=0.730 corr=nan mean_err=34.1% p95=79.6% cond=5.7
  tikhonov_0.01        ratio=0.719 corr=nan mean_err=34.1% p95=79.9% cond=5.7
  tikhonov_0.001       ratio=0.729 corr=nan mean_err=34.1% p95=79.6% cond=5.7

--------------------------------------------------------------------------------
  STRATEGY COMPARISON SUMMARY
--------------------------------------------------------------------------------
  Strategy             SE Ratio   SE Corr    Mean Err   P95 Err    Max Cond  
  ------------------------------------------------------------------------------
  absolute_1e-4        0.729      nan        34.1       79.6       5.7       
  absolute_1e-6        0.729      nan        34.1       79.6       5.7       
  relative_cond100     0.730      nan        34.1       79.6       5.7       
  relative_cond50      0.730      nan        34.1       79.6       5.7       
  tikhonov_0.01        0.719      nan        34.1       79.9       5.7       
  tikhonov_0.001       0.729      nan        34.1       79.6       5.7       

  BEST STRATEGY: relative_cond100

  Part G completed in 0.27s
