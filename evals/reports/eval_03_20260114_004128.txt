/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2897: RuntimeWarning: invalid value encountered in divide
  c /= stddev[:, None]
/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/numpy/lib/function_base.py:2898: RuntimeWarning: invalid value encountered in divide
  c /= stddev[None, :]
============================================================
EVAL 03: LAMBDA ESTIMATION (RUTHLESS)
============================================================

This eval tests Lambda estimation across ALL THREE REGIMES.
We WANT to see FAIL when implementation is wrong.

============================================================
PART A: Regime A (RCT) - ComputeLambda
============================================================

  Test A1: Quadrature vs MC (50k samples)
    Lambda_quad =
      [[0.198986, -0.029888],
       [-0.029888, 0.144326]]
    Eigenvalues: [0.131156, 0.212156]
    Condition number: 1.62
    Determinant: 0.027826
    Lambda_mc =
      [[0.198964, -0.029879],
       [-0.029879, 0.144401]]
    Relative error: 0.03%
    Test A1: PASS (threshold < 1%)

  Test A2: MC convergence rate
    M=  100: error=0.034347
    M=  500: error=0.009617
    M= 1000: error=0.007973
    M= 5000: error=0.006212
    Fitted rate: 0.43 (should be ~0.5)
    Test A2: PASS (0.3 < rate < 0.7)

  Test A3: Y-independence
    ||Lambda1 - Lambda2|| = 0.00e+00
    Test A3: PASS (should be 0)

  Test A4: ComputeLambda package
    Lambda_pkg =
      [[0.198843, -0.029665],
       [-0.029665, 0.144722]]
    Relative error vs quadrature: 0.21%
    Test A4: PASS (threshold < 5%)

  Part A completed in 1.07s

============================================================
PART B: Regime B (Linear) - AnalyticLambda
============================================================

  Test B1: Lambda = E[TT'|X] analytical
    x=0.00: E[T|X]=0.0000, E[T^2|X]=1.0000, cond=1.00, error=0.00e+00
    x=0.25: E[T|X]=0.1250, E[T^2|X]=1.0156, cond=1.28, error=0.00e+00
    x=0.50: E[T|X]=0.2500, E[T^2|X]=1.0625, cond=1.65, error=0.00e+00
    x=0.75: E[T|X]=0.3750, E[T^2|X]=1.1406, cond=2.11, error=0.00e+00
    x=1.00: E[T|X]=0.5000, E[T^2|X]=1.2500, cond=2.69, error=0.00e+00
    Condition number range: [1.00, 2.69]
    Test B1: PASS (max error < 1%)

  Test B2: theta-independence
    Testing at x=0.5 with different theta values
    Max ||Lambda(theta) - Lambda(theta')|| = 0.00e+00
    Test B2: PASS (should be 0)

  Test B3: Confounded T at x=0.25
    n_samples near x: 996
    Lambda_empirical =
      [[1.0000, 0.1551],
       [0.1551, 0.9677]]
    Lambda_oracle =
      [[1.0000, 0.1250],
       [0.1250, 1.0156]]
    Relative error: 4.5%

  Test B3: Confounded T at x=0.50
    n_samples near x: 966
    Lambda_empirical =
      [[1.0000, 0.2042],
       [0.2042, 1.0863]]
    Lambda_oracle =
      [[1.0000, 0.2500],
       [0.2500, 1.0625]]
    Relative error: 4.6%

  Test B3: Confounded T at x=0.75
    n_samples near x: 1009
    Lambda_empirical =
      [[1.0000, 0.3327],
       [0.3327, 1.1633]]
    Lambda_oracle =
      [[1.0000, 0.3750],
       [0.3750, 1.1406]]
    Relative error: 4.0%
    Test B3: PASS (max error < 10%)

  Test B4: AnalyticLambda package (aggregate)
    Lambda_pkg (mean TT') =
      [[1.0000, 0.2300],
       [0.2300, 1.1057]]
    Lambda_oracle at x=0.5 =
      [[1.0000, 0.2500],
       [0.2500, 1.0625]]
    Relative error: 3.4%
    Test B4: PASS (threshold < 20%)

  Part B completed in 0.01s

============================================================
PART C: Regime C (Obs) - EstimateLambda (ALL METHODS)
============================================================

  DGP: Regime C (Confounded Logit)
    alpha*(x) = 0.0 + 0.5*sin(x)
    beta*(x) = 1.0 + 0.5*x
    T | X ~ N(beta*(x), 0.5^2)

  Computing Oracle Lambda(x) for 500 points (MC=5000)...
  Oracle computation time: 7.18s
  Oracle stats:
    eig_max: mean=0.2519, std=0.0985
    eig_min: mean=0.0262, std=0.0207
    element-wise std: 0.0609

  Testing 5 methods: ['aggregate', 'mlp', 'ridge', 'rf', 'lgbm']
------------------------------------------------------------

  --- Method: aggregate ---
    Corr(eig1): 0.0000 FAIL
    Mean Frob:  0.1211 PASS
    Max Frob:   0.1837
    P95 Frob:   0.1735
    Std (x-dep): 0.000000 FAIL
    Min eig:    0.041399 (PSD: 100%)
    Bias:       -0.001129
    Var ratio:  0.0000
    Time:       0.032s (fit=0.023s, pred=0.008s)

  --- Method: mlp ---
    Corr(eig1): 0.9972 PASS
    Mean Frob:  0.0175 PASS
    Max Frob:   0.0507
    P95 Frob:   0.0381
    Std (x-dep): 0.064873 PASS
    Min eig:    0.000100 (PSD: 100%)
    Bias:       0.000710
    Var ratio:  1.1204
    Time:       13.512s (fit=13.472s, pred=0.040s)

  --- Method: ridge ---
    Corr(eig1): 0.5079 FAIL
    Mean Frob:  0.0868 PASS
    Max Frob:   0.1548
    P95 Frob:   0.1438
    Std (x-dep): 0.021756 PASS
    Min eig:    0.000100 (PSD: 100%)
    Bias:       -0.001037
    Var ratio:  0.3786
    Time:       0.043s (fit=0.036s, pred=0.006s)

  --- Method: rf ---
    Corr(eig1): 0.9043 PASS
    Mean Frob:  0.0602 PASS
    Max Frob:   0.4046
    P95 Frob:   0.1782
    Std (x-dep): 0.078460 PASS
    Min eig:    0.000160 (PSD: 100%)
    Bias:       -0.000880
    Var ratio:  1.5834
    Time:       0.226s (fit=0.183s, pred=0.043s)

  --- Method: lgbm ---
    Corr(eig1): 0.9777 PASS
    Mean Frob:  0.0326 PASS
    Max Frob:   0.1489
    P95 Frob:   0.0951
    Std (x-dep): 0.068634 PASS
    Min eig:    0.000100 (PSD: 100%)
    Bias:       -0.001127
    Var ratio:  1.2358
    Time:       0.568s (fit=0.536s, pred=0.032s)

--------------------------------------------------------------------------------
  METHOD COMPARISON TABLE (Extended)
--------------------------------------------------------------------------------
  Method     Corr     Frob     Max      P95      MinEig   PSD%   Time    
  ------------------------------------------------------------------------------
  aggregate  0.0000   0.1211   0.1837   0.1735   0.0414   100    0.032   
  mlp        0.9972   0.0175   0.0507   0.0381   0.0001   100    13.512  
  ridge      0.5079   0.0868   0.1548   0.1438   0.0001   100    0.043   
  rf         0.9043   0.0602   0.4046   0.1782   0.0002   100    0.226   
  lgbm       0.9777   0.0326   0.1489   0.0951   0.0001   100    0.568   

--------------------------------------------------------------------------------
  ADDITIONAL STATISTICS
--------------------------------------------------------------------------------
  Method     Bias       MAE        VarRatio   R²         Result    
  ------------------------------------------------------------------------------
  aggregate  -0.001129  0.055160   0.0000     -0.0009    1/3       
  mlp        0.000710   0.007642   1.1204     0.9672     3/3 PASS  
  ridge      -0.001037  0.041590   0.3786     0.2373     2/3       
  rf         -0.000880  0.025605   1.5834     0.3759     3/3 PASS  
  lgbm       -0.001127  0.013249   1.2358     0.8315     3/3 PASS  

  BEST METHOD: mlp (3/3 tests passed)

  Part C completed in 21.60s
    - Oracle computation: 7.18s
    - aggregate: 0.03s
    - mlp: 13.51s
    - ridge: 0.04s
    - rf: 0.23s
    - lgbm: 0.57s

============================================================
TIMING SUMMARY
============================================================
  Part A (RCT):           1.07s
  Part B (Linear):        0.01s
  Part C (Observational): 21.60s
  ------------------------------
  TOTAL:                  22.68s

============================================================
SUMMARY
============================================================

  Part A (RCT):
    A1: Quadrature vs MC............PASS (0.03%)
    A2: MC convergence rate.........PASS (rate=0.43)
    A3: Y-independence..............PASS (diff=0.00e+00)
    A4: ComputeLambda package.......PASS (0.21%)

  Part B (Linear):
    B1: Lambda = E[TT'|X]...........PASS (error=0.00e+00)
    B2: theta-independence..........PASS (diff=0.00e+00)
    B3: Confounded T................PASS (error=4.6%)
    B4: AnalyticLambda package......PASS (3.4%)

  Part C (Observational):
    C1: Corr(lambda_1_hat, lambda_1*)..PASS (1.00)
    C2: Mean Frobenius..............PASS (0.0175)
    C3: x-dependence................PASS (std=0.0649)

============================================================
STATISTICS SUMMARY (Best Method: mlp)
============================================================
  Correlation:     0.9972 (threshold: 0.70)
  Mean Frobenius:  0.0175 (threshold: 0.15)
  Max Frobenius:   0.0507
  95th percentile: 0.0381
  Min Eigenvalue:  0.000100 (>0 = PSD)
  PSD Rate:        100%
  Bias:            0.000710 (should be ~0)
  Variance Ratio:  1.1204 (should be ~1)
  Mean R²:         0.9672

============================================================
EVAL 03: 11/11 PASSED
STATUS: ALL PASS
============================================================

============================================================
PART E: METHOD FAILURE ANALYSIS (BRUTAL)
============================================================

  METHOD FAILURE MODES:
  ------------------------------------------------------------------------------
  Method       Works                     Breaks                    Fatal?    
  ------------------------------------------------------------------------------
  aggregate    Frobenius error           eigenvalue correlation,   YES       
  mlp          eigenvalue correlation,   Nothing                   No        
  ridge        x-dependence, Frobenius   eigenvalue correlation    No        
  rf           eigenvalue correlation,   Nothing                   No        
  lgbm         eigenvalue correlation,   Nothing                   No        

  CRITICAL WARNINGS:
    - aggregate: eigenvalue correlation, ZERO x-dependence - DO NOT USE FOR REGIME C

============================================================
PART F: SE PROPAGATION TEST (THE CRITICAL QUESTION)
============================================================

  Does Lambda error actually affect SE estimates?

  ----------------------------------------------------------------------
  Method       SE Ratio     SE Corr      Mean Error   Worst Error 
  ----------------------------------------------------------------------
  aggregate    0.730        nan          34.1        % 82.3        % <- DANGER
  mlp          2.213        0.600        129.0       % 1174.3      % <- DANGER
  ridge        1.768        0.911        102.9       % 585.2       % <- DANGER
  rf           1.566        0.860        59.5        % 248.2       % <- DANGER
  lgbm         1.613        0.611        67.8        % 922.4       % <- DANGER

  INTERPRETATION:
    SE Ratio ~1.0: Lambda errors don't bias SE
    SE Corr ~1.0: Lambda errors don't distort SE distribution
    Worst Error >30%: Some observations have dangerous SE errors

============================================================
BRUTAL EVAL SUMMARY
============================================================

  Per-method results:
    aggregate: 1/3 <- BROKEN
    mlp: PASS
    ridge: 2/3
    rf: PASS
    lgbm: PASS

  SE impact (worst-case error):
    aggregate: 82% <- DANGER
    mlp: 1174% <- DANGER
    ridge: 585% <- DANGER
    rf: 248% <- DANGER
    lgbm: 922% <- DANGER
